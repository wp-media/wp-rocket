on: 
  pull_request:
    branches:
      - dev/*

name: Deploy new WP Instance
jobs:
  deploy:
    name: deploy new WP instance to cluster
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ['7.4']
          tools: composer:v1
      - name: Run composer
        run: composer install
      - name: parse ingress
        run: sed -i "s|CHANGEME|${GITHUB_REF##*/}|g" k8s/ingress.yaml 
      - name: create Helm values.yml
        uses: "finnp/create-file-action@master"
        env:
          FILE_NAME: "values.yml"
          FILE_BASE64: "${{ secrets.HELM_VALUES }}"
      - name: deploy to cluster
        uses: wahyd4/kubectl-helm-action@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        with:
          args: |
            kubectl create namespace ${GITHUB_REF##*/}
            helm repo add bitnami https://charts.bitnami.com/bitnami
            helm install ${GITHUB_REF##*/} bitnami/wordpress -f values.yml -n ${GITHUB_REF##*/}
            kubectl get secret dev-tls --namespace=default --export -o yaml | kubectl apply --namespace=${GITHUB_REF##*/} -f -
            kubectl apply -f k8s/ingress.yaml
            export PODNAME=$(kubectl get pods --context kubernetes-admin@TST-SBG5-MAN-K8S-01 -A | grep ${GITHUB_REF##*/} | grep wordpress | awk '{print $2}')
            kubectl cp . $PODNAME:/opt/bitnami/wordpress/wp-content/plugins/wp-rocket

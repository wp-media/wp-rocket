class RocketBeacon{constructor(e){this.config=e,this.lcpBeacon=null,this.infiniteLoopId=null,this.scriptTimer=new Date,this.errorCode=""}async init(){if(!await this._isValidPreconditions()){this._finalize();return}this.infiniteLoopId=setTimeout(()=>{this._handleInfiniteLoop()},1e4);let e=await this._isGeneratedBefore();e.lcp||(this.lcpBeacon=new RocketLcpBeacon(this.config),await this.lcpBeacon.run()),this._saveFinalResultIntoDB()}async _isValidPreconditions(){return this._isNotValidScreensize()?(this._logMessage("Bailing out because screen size is not acceptable"),!1):!(this._isPageCached()&&await this._isGeneratedBefore())||(this._logMessage("Bailing out because data is already available"),!1)}_isPageCached(){let e=document.documentElement.nextSibling&&document.documentElement.nextSibling.data?document.documentElement.nextSibling.data:"";return e&&e.includes("Debug: cached")}async _isGeneratedBefore(){let e=new FormData;e.append("action","rocket_check_beacon"),e.append("rocket_beacon_nonce",this.config.nonce),e.append("url",this.config.url),e.append("is_mobile",this.config.is_mobile);let t=await fetch(this.config.ajax_url,{method:"POST",credentials:"same-origin",body:e}).then(e=>e.json());return t.data}_isNotValidScreensize(){let e=window.innerWidth||document.documentElement.clientWidth,t=window.innerHeight||document.documentElement.clientHeight,i=this.config.is_mobile&&(e>this.config.width_threshold||t>this.config.height_threshold),n=!this.config.is_mobile&&(e<this.config.width_threshold||t<this.config.height_threshold);return i||n}static _isIntersecting(e){return e.bottom>=0&&e.right>=0&&e.top<=(window.innerHeight||document.documentElement.clientHeight)&&e.left<=(window.innerWidth||document.documentElement.clientWidth)}_saveFinalResultIntoDB(){let e=this.lcpBeacon?this.lcpBeacon.getResults():null,t=new FormData;t.append("action","rocket_beacon"),t.append("rocket_beacon_nonce",this.config.nonce),t.append("url",this.config.url),t.append("is_mobile",this.config.is_mobile),t.append("status",this._getFinalStatus()),t.append("lcp_images",JSON.stringify(e)),fetch(this.config.ajax_url,{method:"POST",credentials:"same-origin",body:t,headers:{"wpr-saas-no-intercept":!0}}).then(e=>e.json()).then(e=>{this._logMessage(e)}).catch(e=>{this._logMessage(e)}).finally(()=>{this._finalize()})}_getFinalStatus(){if(""!==this.errorCode)return this.errorCode;let e=(new Date-this.scriptTimer)/1e3;return 10<=e?"timeout":"success"}_handleInfiniteLoop(){this._saveFinalResultIntoDB()}_finalize(){let e=document.querySelector('[data-name="wpr-wpr-beacon"]');e.setAttribute("beacon-completed","true"),clearTimeout(this.infiniteLoopId)}_logMessage(e){this.config.debug&&console.log(e)}static run(){if(!window.rocket_beacon_data)return;let e=new RocketBeacon(window.rocket_beacon_data);if("loading"!==document.readyState){setTimeout(()=>{e.init()},window.rocket_beacon_data.delay);return}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{e.init()},window.rocket_beacon_data.delay)})}}class RocketLcpBeacon{constructor(e){this.config=e,this.performanceImages=[],this.errorCode=""}async run(){try{let e=this._generateLcpCandidates(1/0);e&&(this._initWithFirstElementWithInfo(e),this._fillATFWithoutDuplications(e))}catch(t){this.errorCode="script_error",this._logMessage("Script Error: "+t)}}_generateLcpCandidates(e){let t=document.querySelectorAll(this.config.elements);if(t.length<=0)return[];let i=Array.from(t),n=i.map(e=>{if("img"===e.nodeName.toLowerCase()&&"picture"===e.parentElement.nodeName.toLowerCase())return null;let t;if("picture"===e.nodeName.toLowerCase()){let i=e.querySelector("img");if(!i)return null;t=i.getBoundingClientRect()}else t=e.getBoundingClientRect();return{element:e,rect:t}}).filter(e=>null!==e).filter(e=>e.rect.width>0&&e.rect.height>0&&RocketBeacon._isIntersecting(e.rect)).map(e=>({item:e,area:this._getElementArea(e.rect),elementInfo:this._getElementInfo(e.element)})).sort((e,t)=>t.area-e.area).slice(0,e);return n.map(e=>({element:e.item.element,elementInfo:e.elementInfo}))}_getElementArea(e){let t=Math.min(e.width,(window.innerWidth||document.documentElement.clientWidth)-e.left),i=Math.min(e.height,(window.innerHeight||document.documentElement.clientHeight)-e.top);return t*i}_getElementInfo(e){let t=e.nodeName.toLowerCase(),i={type:"",src:"",srcset:"",sizes:"",sources:[],bg_set:[],current_src:""};if("img"===t&&e.srcset)i.type="img-srcset",i.src=e.src,i.srcset=e.srcset,i.sizes=e.sizes,i.current_src=e.currentSrc;else if("img"===t)i.type="img",i.src=e.src,i.current_src=e.currentSrc;else if("video"===t){i.type="img";let n=e.querySelector("source");i.src=e.poster||(n?n.src:""),i.current_src=i.src}else if("svg"===t){let s=e.querySelector("image");s&&(i.type="img",i.src=s.getAttribute("href")||"",i.current_src=i.src)}else if("picture"===t){i.type="picture";let r=e.querySelector("img");i.src=r?r.src:"",i.sources=Array.from(e.querySelectorAll("source")).map(e=>({srcset:e.srcset||"",media:e.media||"",type:e.type||"",sizes:e.sizes||""}))}else{let c=window.getComputedStyle(e,null),o=[c.getPropertyValue("background-image"),getComputedStyle(e,":after").getPropertyValue("background-image"),getComputedStyle(e,":before").getPropertyValue("background-image")].filter(e=>"none"!==e);if(0===o.length)return null;let a=o[0];if(i.type="bg-img",a.includes("image-set(")&&(i.type="bg-img-set"),!a||""===a||a.includes("data:image"))return null;let l=[...a.matchAll(/url\(\s*?['"]?\s*?(.+?)\s*?["']?\s*?\)/ig)];i.bg_set=l.map(e=>e[1]?{src:e[1].trim()+(e[2]?" "+e[2].trim():"")}:{}),i.bg_set.every(e=>""===e.src)&&(i.bg_set=l.map(e=>e[1]?{src:e[1].trim()}:{})),i.bg_set.length>0&&(i.src=i.bg_set[0].src,"bg-img-set"===i.type&&(i.src=i.bg_set))}return i}_initWithFirstElementWithInfo(e){let t=e.find(e=>null!==e.elementInfo);if(!t){this._logMessage("No LCP candidate found."),this.performanceImages=[];return}this.performanceImages=[{...t.elementInfo,label:"lcp"}]}_fillATFWithoutDuplications(e){e.forEach(({element:e,elementInfo:t})=>{!this._isDuplicateImage(e)&&t&&this.performanceImages.push({...t,label:"above-the-fold"})})}_isDuplicateImage(e){let t=this._getElementInfo(e);if(null===t)return!1;let i="img"===t.type||"img-srcset"===t.type||"video"===t.type,n="bg-img"===t.type||"bg-img-set"===t.type||"picture"===t.type;return(i||n)&&this.performanceImages.some(e=>e.src===t.src)}_logMessage(e){this.config.debug&&console.log(e)}getResults(){return this.performanceImages}}RocketBeacon.run();